<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPMB SMP Muslimin Cililin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* CSS yang sudah ada - TIDAK DIUBAH */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #4CAF50 75%, #81C784 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            color: #333;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(76, 175, 80, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(30, 60, 114, 0.3) 0%, transparent 50%);
            z-index: -1;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(1deg);
            }
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: slideUp 1s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .school-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .school-title {
            margin-bottom: 30px;
        }

        .school-title h1 {
            color: #1e3c72;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .school-title h2 {
            color: #4CAF50;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.2;
        }

        .login-form {
            text-align: left;
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 16px;
            /* IMPROVED: 14px â†’ 16px */
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            /* IMPROVED: 14px â†’ 16px */
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.15);
            transform: translateY(-2px);
        }

        /* PASSWORD VISIBILITY TOGGLE - NEW */
        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: #4CAF50;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            /* IMPROVED: 14px â†’ 16px */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
        }

        .login-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* LOGIN ERROR MESSAGES - IMPROVED */
        .login-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #dc3545;
            animation: shake 0.5s ease-in-out;
        }

        .login-error.show {
            display: block;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .login-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #28a745;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* LOADING INDICATOR - NEW */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Main App Styles - TIDAK DIUBAH */
        .app-container {
            display: none;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.8s ease-out;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .header-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            position: relative;
            z-index: 2;
        }

        .header h1 {
            position: relative;
            z-index: 2;
            margin-bottom: 5px;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header h2 {
            position: relative;
            z-index: 2;
            margin-bottom: 5px;
            font-size: 20px;
            font-weight: 600;
            opacity: 0.9;
        }

        .header p {
            position: relative;
            z-index: 2;
            opacity: 0.8;
            font-size: 16px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            z-index: 3;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* SESSION INFO - NEW */
        .session-info {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 3;
            backdrop-filter: blur(10px);
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .nav {
            display: flex;
            background: rgba(248, 249, 250, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(222, 226, 230, 0.5);
            flex-wrap: wrap;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .nav-btn {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            color: #495057;
            min-width: 160px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 4px;
            background: linear-gradient(90deg, #1e3c72, #4CAF50, #81C784);
            transition: all 0.4s ease;
            transform: translateX(-50%);
            border-radius: 2px 2px 0 0;
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(30, 60, 114, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-btn:hover {
            color: #4CAF50;
            transform: translateY(-3px);
        }

        .nav-btn:hover::before {
            width: 80%;
        }

        .nav-btn:hover::after {
            opacity: 1;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(30, 60, 114, 0.3);
        }

        .nav-btn.active::before {
            width: 100%;
            background: rgba(255, 255, 255, 0.4);
        }

        .nav-btn.active::after {
            opacity: 0;
        }

        .page {
            display: none;
            padding: 35px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            /* IMPROVED: 500 â†’ 600 */
            color: #495057;
            font-size: 16px;
            /* IMPROVED: Added explicit 16px */
        }

        .required {
            color: #dc3545;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            /* IMPROVED: 14px â†’ 16px */
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.15);
            transform: translateY(-2px);
            background: white;
        }

        input:hover,
        select:hover,
        textarea:hover {
            border-color: #ced4da;
            transform: translateY(-1px);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            /* IMPROVED: 14px â†’ 16px */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 8px;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 193, 7, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(220, 53, 69, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #5bc0de 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
        }

        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(23, 162, 184, 0.4);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .data-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 15px 18px;
            border-bottom: 1px solid rgba(222, 226, 230, 0.5);
            transition: all 0.3s ease;
        }

        .data-table tr:hover {
            background: linear-gradient(135deg, rgba(30, 60, 114, 0.05) 0%, rgba(76, 175, 80, 0.05) 100%);
            transform: scale(1.01);
        }

        .stats {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            cursor: pointer;
            min-width: 200px;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(30, 60, 114, 0.3);
        }

        .stat-card:hover::before {
            transform: scale(1);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .alert-success {
            background: linear-gradient(135deg, #d1ecf1 0%, #d4edda 100%);
            color: #155724;
            border: 2px solid #bee5eb;
            border-radius: 15px;
            padding: 18px;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 8px 25px rgba(21, 87, 36, 0.1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-box {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* BACKUP STATUS - IMPROVED */
        .backup-status {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            border: 2px solid #bee5eb;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .backup-status.success {
            background: linear-gradient(135deg, #d4edda 0%, #e8f5e8 100%);
            border-color: #28a745;
            color: #155724;
        }

        .backup-status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffc107;
            color: #856404;
        }

        .backup-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            color: white;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .pagination span {
            padding: 8px 16px;
            font-weight: bold;
        }

        /* Loading Indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* TOAST NOTIFICATION - NEW */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .toast.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .toast.info {
            background: linear-gradient(135deg, #17a2b8 0%, #5bc0de 100%);
        }

        /* WhatsApp Button Styling - NEW */
        .whatsapp-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-weight: 600;
        }

        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        /* Phone Number Styling - NEW */
        .phone-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .phone-number {
            color: #4CAF50;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Duplicate Warning - NEW */
        .duplicate-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            align-items: center;
            gap: 10px;
            color: #856404;
            animation: slideDown 0.3s ease-out;
        }

        .duplicate-warning.show {
            display: flex;
        }

        .duplicate-warning button {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn-view-duplicate {
            background: #17a2b8;
            color: white;
        }

        .btn-continue-anyway {
            background: #28a745;
            color: white;
        }

        /* Virtual Scrolling Performance - NEW */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 15px;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 100%);
            border-radius: 10px;
        }

        /* Responsiveness - IMPROVED WITH 16px FONT */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .stats {
                flex-direction: column;
            }

            .data-table {
                font-size: 12px;
                overflow-x: auto;
            }

            .nav {
                flex-direction: column;
            }

            .nav-btn {
                min-width: auto;
            }

            .search-box {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box input {
                width: 100%;
                margin-bottom: 10px;
            }

            .login-card {
                padding: 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header h2 {
                font-size: 25px;
            }

            .page {
                padding: 20px 15px;
            }

            .stat-card {
                min-width: 100%;
            }

            .session-info {
                position: static;
                margin: 10px 0;
                text-align: center;
            }

            /* Font size responsive adjustments */
            input,
            select,
            textarea {
                font-size: 15px;
                /* 16px â†’ 15px on tablet */
            }

            label {
                font-size: 15px;
                /* 16px â†’ 15px on tablet */
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header h2 {
                font-size: 16px;
            }

            .page {
                padding: 20px 15px;
            }

            .stat-card {
                min-width: 100%;
            }

            /* Font size mobile adjustments */
            input,
            select,
            textarea {
                font-size: 14px;
                /* 15px â†’ 14px on mobile */
            }

            label {
                font-size: 14px;
                /* 15px â†’ 14px on mobile */
            }

            .btn {
                font-size: 14px;
                /* 16px â†’ 14px on mobile */
            }

            .phone-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>

<body>
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-card">
                <div class="school-logo">
                    <i class="fas fa-school"></i>
                </div>
                <div class="school-title">
                    <h1>YAYASAN PENDIDIKAN MUSLIMIN (YPM) NURUL ULUM</h1>
                    <h2>SMP MUSLIMIN CILILIN</h2>
                </div>

                <form class="login-form" id="loginForm">
                    <div id="loginError" class="login-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="errorMessage">Username atau password salah!</span>
                    </div>

                    <div id="loginSuccess" class="login-success">
                        <i class="fas fa-check-circle"></i> Login berhasil! Mengalihkan...
                    </div>

                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" placeholder="Masukkan username" required
                            autocomplete="username">
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-container">
                            <input type="password" id="password" placeholder="Masukkan password" required
                                autocomplete="current-password">
                            <button type="button" class="password-toggle" id="passwordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="login-btn" id="loginBtn">
                        <i class="fas fa-lock"></i> Login
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="container">
            <div class="header">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <div class="session-info" id="sessionInfo">
                    Session: <span id="sessionTimer">4:00:00</span>
                </div>
                <div class="header-logo">
                    <i class="fas fa-school"></i>
                </div>
                <h1>SEKOLAH MENENGAH PERTAMA MUSLIMIN CILILIN</h1>
                <h2>Sistem Penerimaan Siswa Baru (SPMB)</h2>
                <p>Tahun Ajaran <span id="currentYear"></span></p>
            </div>

            <div class="nav">
                <button class="nav-btn active" onclick="showPage('form')">
                    <i class="fas fa-file-alt"></i> Form Pendaftaran
                </button>
                <button class="nav-btn" onclick="showPage('list')">
                    <i class="fas fa-list"></i> Data Pendaftar
                </button>
                <button class="nav-btn" onclick="showPage('stats')">
                    <i class="fas fa-chart-bar"></i> Laporan Statistik
                </button>
            </div>

            <div class="page active" id="form">
                <h2><i class="fas fa-file-alt"></i> Form Pendaftaran Calon Siswa Baru</h2>

                <div class="backup-status" id="backupStatus">
                    <div class="backup-indicator"></div>
                    <span><i class="fas fa-shield-alt"></i> <span id="backupStatusText">Sistem backup aktif - Data aman
                            tersimpan</span></span>
                </div>

                <div id="successMessage" class="alert alert-success" style="display: none;">
                    <i class="fas fa-check-circle"></i> Data berhasil disimpan!
                </div>

                <!-- DUPLICATE WARNING - NEW -->
                <div id="duplicateWarning" class="duplicate-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="duplicateMessage">Nama serupa sudah terdaftar!</span>
                    <button class="btn-view-duplicate" onclick="viewDuplicate()">Lihat Data</button>
                    <button class="btn-continue-anyway" onclick="continueAnyway()">Tetap Simpan</button>
                </div>

                <div id="formModeLabel"
                    style="text-align: center; font-weight: bold; color: #4CAF50; margin-bottom: 10px;">
                    Mode: Tambah Data
                </div>

                <form id="studentForm">
                    <div class="form-group">
                        <label>Nama Lengkap <span class="required">*</span></label>
                        <input type="text" id="nama" placeholder="Masukkan nama lengkap sesuai akta kelahiran" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Jenis Kelamin <span class="required">*</span></label>
                            <select id="jenisKelamin" required>
                                <option value="">Pilih Jenis Kelamin...</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tempat Lahir <span class="required">*</span></label>
                            <input type="text" id="tempatLahir" placeholder="Contoh: Bandung" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tanggal Lahir <span class="required">*</span></label>
                        <input type="date" id="tanggalLahir" required>
                    </div>

                    <div class="form-group">
                        <label>Alamat Lengkap <span class="required">*</span></label>
                        <textarea id="alamat" rows="3" placeholder="Masukkan alamat lengkap tempat tinggal saat ini"
                            required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Nama Orang Tua/Wali <span class="required">*</span></label>
                        <input type="text" id="namaOrtu" placeholder="Nama lengkap orang tua/wali" required>
                    </div>

                    <div class="form-group">
                        <label>No. HP Orang Tua <span class="required">*</span></label>
                        <input type="tel" id="hpOrtu" placeholder="Contoh: 08123456789" required>
                    </div>

                    <div class="form-group">
                        <label>Asal Sekolah SD/MI <span class="required">*</span></label>
                        <input type="text" id="asalSekolah" placeholder="Contoh: SDN 01 Cililin" required>
                    </div>

                    <div class="form-group">
                        <label>NISN</label>
                        <input type="text" id="nisn" placeholder="Nomor Induk Siswa Nasional (10 digit)" maxlength="10">
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn btn-warning" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save"></i> Daftar Sekarang
                        </button>
                    </div>
                </form>
            </div>

            <div class="page" id="list">
                <h2><i class="fas fa-list"></i> Daftar Calon Siswa Baru</h2>

                <!-- IMPROVED BACKUP STATUS -->
                <div class="backup-status success" id="dataBackupStatus">
                    <div class="backup-indicator"></div>
                    <span id="backupInfo">ðŸ”„ Auto Backup: Aktif (Last: <span id="lastBackup">-</span>)</span>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ðŸ” Cari nama siswa...">
                    <!-- IMPROVED BACKUP BUTTONS - CLEAN LAYOUT -->
                    <button class="btn btn-danger" onclick="createEmergencyBackup()">
                        <i class="fas fa-exclamation-triangle"></i> Emergency Backup
                    </button>
                    <button class="btn btn-info" onclick="downloadBackup()">
                        <i class="fas fa-download"></i> Download Backup
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <!-- NEW PDF EXPORT BUTTON -->
                    <button class="btn btn-primary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF Laporan
                    </button>
                </div>

                <!-- IMPROVED TABLE WITH VIRTUAL SCROLLING -->
                <div class="table-container">
                    <table class="data-table" id="studentTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Lengkap</th>
                                <th>Jenis Kelamin</th>
                                <th>Tempat, Tanggal Lahir</th>
                                <th>Asal Sekolah</th>
                                <th>No. HP Ortu</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                </div>
            </div>

            <div class="page" id="stats">
                <h2><i class="fas fa-chart-bar"></i> Statistik Pendaftaran</h2>

                <div class="backup-status warning">
                    <div class="backup-indicator"></div>
                    <span><i class="fas fa-info-circle"></i> Data integrity: <span id="dataIntegrity">100%</span> |
                        Version: <span id="dataVersion">1.0</span></span>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPendaftar">0</div>
                        <div>Total Pendaftar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lakiLaki">0</div>
                        <div>Laki-laki</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="perempuan">0</div>
                        <div>Perempuan</div>
                    </div>
                </div>

                <div
                    style="background: rgba(248, 249, 250, 0.8); padding: 20px; border-radius: 15px; margin: 20px 0; backdrop-filter: blur(10px);">
                    <h3><i class="fas fa-school"></i> Ringkasan Pendaftaran</h3>
                    <div id="schoolStats">
                        <p>Belum ada data pendaftaran</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SECURITY & ENCRYPTION SYSTEM - NEW
        class SecurityManager {
            constructor() {
                this.pepper = 'smp_muslimin_cililin_2025';
                this.loginAttempts = 0;
                this.lockoutTime = 10 * 60 * 1000; // 10 minutes
                this.maxAttempts = 3;
                this.sessionDuration = 4 * 60 * 60 * 1000; // 4 hours
            }

            // Simple hash function (in production, use bcrypt or similar)
            hashPassword(password) {
                let hash = 0;
                const str = password + this.pepper;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash).toString(16);
            }

            // Encrypt data for localStorage
            encryptData(data) {
                const jsonStr = JSON.stringify(data);
                let encrypted = '';
                const key = this.pepper.length;

                for (let i = 0; i < jsonStr.length; i++) {
                    encrypted += String.fromCharCode(jsonStr.charCodeAt(i) + key);
                }

                return btoa(encrypted);
            }

            // Decrypt data from localStorage
            decryptData(encryptedData) {
                try {
                    const encrypted = atob(encryptedData);
                    let decrypted = '';
                    const key = this.pepper.length;

                    for (let i = 0; i < encrypted.length; i++) {
                        decrypted += String.fromCharCode(encrypted.charCodeAt(i) - key);
                    }

                    return JSON.parse(decrypted);
                } catch (error) {
                    console.error('Decryption failed:', error);
                    return null;
                }
            }

            // Check if user is locked out
            isLockedOut() {
                const lockoutEnd = localStorage.getItem('lockoutEnd');
                if (lockoutEnd && Date.now() < parseInt(lockoutEnd)) {
                    return true;
                }
                return false;
            }

            // Set lockout
            setLockout() {
                const lockoutEnd = Date.now() + this.lockoutTime;
                localStorage.setItem('lockoutEnd', lockoutEnd.toString());
            }

            // Clear lockout
            clearLockout() {
                localStorage.removeItem('lockoutEnd');
                this.loginAttempts = 0;
            }

            // Validate login
            validateLogin(username, password) {
                if (this.isLockedOut()) {
                    const lockoutEnd = localStorage.getItem('lockoutEnd');
                    const remainingTime = Math.ceil((parseInt(lockoutEnd) - Date.now()) / 60000);
                    return { success: false, message: `Akun terblokir. Coba lagi dalam ${remainingTime} menit.` };
                }

                const validUsername = 'admin';
                const validPasswordHash = this.hashPassword('smpmuslimin');

                if (username !== validUsername) {
                    this.loginAttempts++;
                    if (this.loginAttempts >= this.maxAttempts) {
                        this.setLockout();
                        return { success: false, message: 'Terlalu banyak percobaan login. Akun diblokir 10 menit.' };
                    }
                    return { success: false, message: 'Username tidak ditemukan.' };
                }

                if (this.hashPassword(password) !== validPasswordHash) {
                    this.loginAttempts++;
                    if (this.loginAttempts >= this.maxAttempts) {
                        this.setLockout();
                        return { success: false, message: 'Terlalu banyak percobaan login. Akun diblokir 10 menit.' };
                    }
                    const remaining = this.maxAttempts - this.loginAttempts;
                    return { success: false, message: `Password salah. Sisa ${remaining} percobaan lagi.` };
                }

                this.clearLockout();
                return { success: true, message: 'Login berhasil!' };
            }

            // Create session
            createSession() {
                const sessionStart = Date.now();
                const sessionEnd = sessionStart + this.sessionDuration;
                localStorage.setItem('sessionStart', sessionStart.toString());
                localStorage.setItem('sessionEnd', sessionEnd.toString());
                localStorage.setItem('isLoggedIn', 'true');
            }

            // Check session validity
            isSessionValid() {
                const sessionEnd = localStorage.getItem('sessionEnd');
                const isLoggedIn = localStorage.getItem('isLoggedIn');

                if (!sessionEnd || !isLoggedIn) return false;

                return Date.now() < parseInt(sessionEnd);
            }

            // Clear session
            clearSession() {
                localStorage.removeItem('sessionStart');
                localStorage.removeItem('sessionEnd');
                localStorage.removeItem('isLoggedIn');
            }

            // Get remaining session time
            getSessionTimeRemaining() {
                const sessionEnd = localStorage.getItem('sessionEnd');
                if (!sessionEnd) return 0;

                const remaining = Math.max(0, parseInt(sessionEnd) - Date.now());
                return remaining;
            }
        }

        // ENHANCED BACKUP SYSTEM - IMPROVED
        class BackupManager {
            constructor() {
                this.backupInterval = 30 * 60 * 1000; // 30 minutes
                this.maxBackups = 10;
                this.backupPrefix = 'smpmuslimin_backup_';
                this.autoBackupCounter = 0;
            }

            checkStorageUsage() {
                const used = JSON.stringify(localStorage).length;
                const usedMB = (used / 1024 / 1024).toFixed(2);
                console.log(`Storage used: ${usedMB}MB`);

                if (used > 8000000) { // 8MB warning
                    showToast('Storage hampir penuh! Pertimbangkan arsipkan data lama.', 'warning');
                }

                return { used, usedMB };
            }

            // IMPROVED: Auto backup with smart triggers
            createAutoBackup(students) {
                const timestamp = Date.now();
                const backupData = {
                    timestamp: timestamp,
                    version: '1.0',
                    totalStudents: students.length,
                    data: students,
                    checksum: this.calculateChecksum(students)
                };

                const backupKey = this.backupPrefix + timestamp;
                const encryptedBackup = securityManager.encryptData(backupData);

                try {
                    localStorage.setItem(backupKey, encryptedBackup);
                    localStorage.setItem('lastBackupTime', timestamp.toString());

                    // Clean old backups
                    this.cleanOldBackups();
                    this.updateBackupStatus();

                    // IMPROVED: Auto download every 50 students
                    this.autoBackupCounter++;
                    if (students.length > 0 && students.length % 50 === 0 && this.autoBackupCounter % 5 === 0) {
                        this.downloadBackupFile(backupData, `Auto_Backup_${students.length}_siswa`);
                        showToast(`Auto download backup: ${students.length} siswa terdaftar!`, 'info');
                    }

                    console.log('Auto backup created:', new Date(timestamp).toLocaleString());
                    return true;
                } catch (error) {
                    console.error('Auto backup failed:', error);
                    this.updateBackupStatus('warning', 'Auto backup gagal');
                    return false;
                }
            }

            // IMPROVED: Emergency backup with instant download
            createEmergencyBackup(students) {
                const timestamp = Date.now();
                const backupData = {
                    timestamp: timestamp,
                    version: '1.0',
                    type: 'emergency',
                    totalStudents: students.length,
                    data: students,
                    checksum: this.calculateChecksum(students),
                    reason: 'Manual emergency backup'
                };

                // Save to localStorage
                const backupKey = 'emergency_backup_' + timestamp;
                const encryptedBackup = securityManager.encryptData(backupData);
                localStorage.setItem(backupKey, encryptedBackup);

                // IMPROVED: Download with better filename
                const dateStr = new Date().toISOString().split('T')[0];
                this.downloadBackupFile(backupData, `EMERGENCY_BACKUP_SMP_Muslimin_${dateStr}_${students.length}siswa`);

                showToast('Emergency backup berhasil dibuat dan didownload!', 'success');
                this.updateBackupStatus();
                return true;
            }

            // NEW: Download backup file helper
            downloadBackupFile(backupData, filename) {
                const jsonStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Calculate data checksum
            calculateChecksum(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            // Verify data integrity
            verifyDataIntegrity(students) {
                const expectedChecksum = this.calculateChecksum(students);
                const lastChecksum = localStorage.getItem('lastDataChecksum');

                localStorage.setItem('lastDataChecksum', expectedChecksum);

                if (lastChecksum && lastChecksum !== expectedChecksum) {
                    console.warn('Data integrity check: Data has been modified');
                    return false;
                }

                return true;
            }

            // Clean old backups
            cleanOldBackups() {
                const allKeys = Object.keys(localStorage);
                const backupKeys = allKeys.filter(key => key.startsWith(this.backupPrefix));

                if (backupKeys.length > this.maxBackups) {
                    // Sort by timestamp (oldest first)
                    backupKeys.sort((a, b) => {
                        const timestampA = parseInt(a.replace(this.backupPrefix, ''));
                        const timestampB = parseInt(b.replace(this.backupPrefix, ''));
                        return timestampA - timestampB;
                    });

                    // Remove oldest backups
                    const toRemove = backupKeys.slice(0, backupKeys.length - this.maxBackups);
                    toRemove.forEach(key => {
                        localStorage.removeItem(key);
                        console.log('Removed old backup:', key);
                    });
                }
            }

            // IMPROVED: Update backup status with better info
            updateBackupStatus() {
                const lastBackupTime = localStorage.getItem('lastBackupTime');
                const lastBackupDate = lastBackupTime
                    ? new Date(parseInt(lastBackupTime))
                    : null;

                const backupInfo = document.getElementById('backupInfo');
                const lastBackupSpan = document.getElementById('lastBackup');

                if (lastBackupDate) {
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastBackupDate) / (1000 * 60));

                    let timeText;
                    if (diffMinutes < 1) {
                        timeText = 'Baru saja';
                    } else if (diffMinutes < 60) {
                        timeText = `${diffMinutes} menit lalu`;
                    } else {
                        const diffHours = Math.floor(diffMinutes / 60);
                        timeText = `${diffHours} jam lalu`;
                    }

                    if (lastBackupSpan) lastBackupSpan.textContent = timeText;
                    if (backupInfo) {
                        backupInfo.innerHTML = `ðŸ”„ Auto Backup: Aktif (Last: ${timeText})`;
                    }
                } else {
                    if (lastBackupSpan) lastBackupSpan.textContent = 'Belum pernah';
                    if (backupInfo) {
                        backupInfo.innerHTML = 'ðŸ”„ Auto Backup: Aktif (Last: Belum pernah)';
                    }
                }
            }

            // Start automatic backup
            startAutoBackup() {
                setInterval(() => {
                    if (students.length > 0) {
                        this.createAutoBackup(students);
                    }
                }, this.backupInterval);

                // Initial backup check
                const lastBackupTime = localStorage.getItem('lastBackupTime');
                if (!lastBackupTime || (Date.now() - parseInt(lastBackupTime)) > this.backupInterval) {
                    if (students.length > 0) {
                        this.createAutoBackup(students);
                    }
                }

                // Update status every minute
                setInterval(() => {
                    this.updateBackupStatus();
                }, 60000);

                // Initial status update
                this.updateBackupStatus();
            }
        }

        // NEW: DUPLICATE DETECTION SYSTEM
        class DuplicateDetector {
            constructor() {
                this.threshold = 0.8; // Similarity threshold
            }

            // Calculate string similarity using Levenshtein distance
            calculateSimilarity(str1, str2) {
                const s1 = str1.toLowerCase().trim();
                const s2 = str2.toLowerCase().trim();

                if (s1 === s2) return 1.0;

                const longer = s1.length > s2.length ? s1 : s2;
                const shorter = s1.length > s2.length ? s2 : s1;

                if (longer.length === 0) return 1.0;

                const distance = this.levenshteinDistance(longer, shorter);
                return (longer.length - distance) / longer.length;
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];

                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }

                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }

                return matrix[str2.length][str1.length];
            }

            // Check for duplicates in existing students
            checkForDuplicates(newName, existingStudents, excludeIndex = -1) {
                const duplicates = [];

                existingStudents.forEach((student, index) => {
                    if (index === excludeIndex) return; // Skip current editing student

                    const similarity = this.calculateSimilarity(newName, student.nama);
                    if (similarity >= this.threshold) {
                        duplicates.push({
                            student: student,
                            similarity: similarity,
                            index: index
                        });
                    }
                });

                return duplicates.sort((a, b) => b.similarity - a.similarity);
            }

            // Show duplicate warning
            showDuplicateWarning(duplicates, callback) {
                const warningDiv = document.getElementById('duplicateWarning');
                const messageSpan = document.getElementById('duplicateMessage');

                if (duplicates.length > 0) {
                    const bestMatch = duplicates[0];
                    const percentage = Math.round(bestMatch.similarity * 100);

                    messageSpan.innerHTML = `
                        Nama serupa "${bestMatch.student.nama}" sudah terdaftar! 
                        (${percentage}% kemiripan)
                    `;

                    warningDiv.classList.add('show');

                    // Store callback and duplicate info for buttons
                    window.duplicateCallback = callback;
                    window.duplicateInfo = bestMatch;
                } else {
                    warningDiv.classList.remove('show');
                }
            }

            // Hide duplicate warning
            hideDuplicateWarning() {
                const warningDiv = document.getElementById('duplicateWarning');
                warningDiv.classList.remove('show');
            }
        }

        // NEW: PDF EXPORT SYSTEM
        class PDFExporter {
            constructor() {
                this.schoolName = 'SMP MUSLIMIN CILILIN';
                this.schoolAddress = 'Jl. Raya Cililin, Bandung Barat';
            }

            // Generate PDF report for principal
            generateReport(students) {
                if (typeof jsPDF === 'undefined') {
                    showToast('PDF library tidak tersedia!', 'error');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header with school info
                this.addHeader(doc);

                // Statistics summary
                this.addStatistics(doc, students);

                // Student list table
                this.addStudentTable(doc, students);

                // Footer with signature
                this.addFooter(doc);

                // Save PDF
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = `Laporan_Pendaftaran_SMP_Muslimin_${dateStr}.pdf`;
                doc.save(filename);

                showToast('Laporan PDF berhasil dibuat!', 'success');
            }

            addHeader(doc) {
                // School logo area (rectangle placeholder)
                doc.setFillColor(30, 60, 114);
                doc.rect(20, 20, 25, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.text('SMP', 32.5, 32.5, { align: 'center' });

                // School name and title
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(this.schoolName, 50, 28);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(this.schoolAddress, 50, 35);

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN PENDAFTARAN SISWA BARU', 105, 55, { align: 'center' });

                const currentYear = getCurrentAcademicYear();
                doc.setFontSize(14);
                doc.text(`Tahun Ajaran ${currentYear}`, 105, 65, { align: 'center' });

                // Date
                const today = new Date().toLocaleDateString('id-ID');
                doc.setFontSize(10);
                doc.text(`Tanggal Cetak: ${today}`, 150, 75);

                return 85; // Return Y position for next content
            }

            addStatistics(doc, students) {
                let yPos = 90;

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('RINGKASAN STATISTIK', 20, yPos);

                yPos += 15;

                const total = students.length;
                const male = students.filter(s => s.jenisKelamin === 'Laki-laki').length;
                const female = students.filter(s => s.jenisKelamin === 'Perempuan').length;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');

                // Statistics boxes
                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos, 50, 20, 'F');
                doc.rect(75, yPos, 50, 20, 'F');
                doc.rect(130, yPos, 50, 20, 'F');

                doc.setFontSize(10);
                doc.text('Total Pendaftar', 45, yPos + 7, { align: 'center' });
                doc.text('Laki-laki', 100, yPos + 7, { align: 'center' });
                doc.text('Perempuan', 155, yPos + 7, { align: 'center' });

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(total.toString(), 45, yPos + 15, { align: 'center' });
                doc.text(male.toString(), 100, yPos + 15, { align: 'center' });
                doc.text(female.toString(), 155, yPos + 15, { align: 'center' });

                return yPos + 35;
            }

            addStudentTable(doc, students) {
                let yPos = 140;

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('DAFTAR SISWA TERDAFTAR', 20, yPos);

                yPos += 10;

                // Prepare data for table
                const tableData = students.map((student, index) => [
                    (index + 1).toString(),
                    student.nama,
                    student.jenisKelamin,
                    `${student.tempatLahir}, ${formatDate(student.tanggalLahir)}`,
                    student.asalSekolah,
                    student.hpOrtu
                ]);

                // Add table using autoTable plugin
                if (typeof doc.autoTable === 'function') {
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [['No', 'Nama Lengkap', 'L/P', 'TTL', 'Asal Sekolah', 'HP Ortu']],
                        body: tableData,
                        styles: {
                            fontSize: 9,
                            cellPadding: 3,
                        },
                        headStyles: {
                            fillColor: [30, 60, 114],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 15 },
                            1: { cellWidth: 45 },
                            2: { halign: 'center', cellWidth: 15 },
                            3: { cellWidth: 45 },
                            4: { cellWidth: 40 },
                            5: { cellWidth: 30 }
                        }
                    });
                }
            }

            addFooter(doc) {
                const pageHeight = doc.internal.pageSize.height;
                const yPos = pageHeight - 40;

                // Signature area
                doc.setFontSize(12);
                doc.text('Cililin, ' + new Date().toLocaleDateString('id-ID'), 130, yPos);
                doc.text('Kepala Sekolah', 130, yPos + 10);

                // Signature box
                doc.rect(130, yPos + 15, 60, 20);

                doc.setFontSize(10);
                doc.text('(.............................)', 160, yPos + 40, { align: 'center' });
                doc.text('NIP. ', 160, yPos + 45, { align: 'center' });
            }
        }

        // PERFORMANCE OPTIMIZER - NEW
        class PerformanceOptimizer {
            constructor() {
                this.virtualScrolling = false;
                this.searchTimeout = null;
                this.renderBatch = 50; // Render 50 rows at a time
            }

            // Optimize table rendering for large datasets
            optimizeTableRendering(students, searchTerm = '') {
                const tbody = document.getElementById('studentTableBody');
                const container = document.querySelector('.table-container');

                if (students.length > 100) {
                    // Enable virtual scrolling for performance
                    this.enableVirtualScrolling(container, students, searchTerm);
                } else {
                    // Standard rendering for smaller datasets
                    this.standardRendering(tbody, students, searchTerm);
                }
            }

            enableVirtualScrolling(container, students, searchTerm) {
                // Filter students
                let filteredStudents = students;
                if (searchTerm) {
                    filteredStudents = students.filter(student =>
                        student.nama.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        student.asalSekolah.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        student.namaOrtu.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                // Calculate visible rows
                const rowHeight = 60; // Approximate row height
                const containerHeight = container.clientHeight || 600;
                const visibleRows = Math.ceil(containerHeight / rowHeight);
                const bufferRows = 5;

                let scrollTop = container.scrollTop || 0;
                let startIndex = Math.floor(scrollTop / rowHeight);
                let endIndex = Math.min(startIndex + visibleRows + bufferRows, filteredStudents.length);

                startIndex = Math.max(0, startIndex - bufferRows);

                this.renderStudentRows(filteredStudents.slice(startIndex, endIndex), startIndex);
            }

            standardRendering(tbody, students, searchTerm) {
                // Standard rendering (existing implementation)
                displayStudents();
            }

            renderStudentRows(studentsSlice, startIndex) {
                const tbody = document.getElementById('studentTableBody');
                let html = '';

                studentsSlice.forEach((student, index) => {
                    const actualIndex = startIndex + index;
                    const bgColor = student.jenisKelamin === 'Laki-laki' ? '#e3f2fd' : '#fce4ec';
                    const textColor = student.jenisKelamin === 'Laki-laki' ? '#1976d2' : '#c2185b';

                    html += `
                        <tr>
                            <td>${actualIndex + 1}</td>
                            <td><strong>${student.nama}</strong></td>
                            <td><span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; background: ${bgColor}; color: ${textColor}">
                                ${student.jenisKelamin}
                            </span></td>
                            <td>${student.tempatLahir}, ${formatDate(student.tanggalLahir)}</td>
                            <td>${student.asalSekolah}</td>
                            <td>${this.renderPhoneNumber(student.hpOrtu, student.namaOrtu)}</td>
                            <td>
                                <button class="btn btn-warning" onclick="editStudent(${students.indexOf(student)})" style="padding: 8px 12px; margin: 2px; font-size: 12px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteStudent(${students.indexOf(student)})" style="padding: 8px 12px; margin: 2px; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            }

            // IMPROVED: WhatsApp phone number rendering
            renderPhoneNumber(phoneNumber, parentName) {
                const cleanPhone = phoneNumber.replace(/\D/g, ''); // Remove non-digits
                let waPhone = cleanPhone;

                // Convert to WhatsApp format
                if (waPhone.startsWith('0')) {
                    waPhone = '62' + waPhone.substring(1);
                } else if (!waPhone.startsWith('62')) {
                    waPhone = '62' + waPhone;
                }

                return `
                    <div class="phone-container">
                        <a href="https://wa.me/${waPhone}" 
                           class="phone-number" 
                           target="_blank"
                           onclick="showWhatsAppToast('${parentName}')">
                            <i class="fas fa-phone"></i> ${phoneNumber}
                        </a>
                        <a href="https://wa.me/${waPhone}" 
                           class="whatsapp-btn" 
                           target="_blank"
                           onclick="showWhatsAppToast('${parentName}')">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    </div>
                `;
            }

            // Debounced search
            debouncedSearch(callback, delay = 300) {
                return (searchTerm) => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        callback(searchTerm);
                    }, delay);
                };
            }
        }

        // TOAST NOTIFICATION SYSTEM - ENHANCED
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                    type === 'info' ? 'fa-info-circle' : 'fa-exclamation-triangle';

            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, type === 'info' ? 4000 : 3000);
        }

        // NEW: WhatsApp Toast
        function showWhatsAppToast(parentName) {
            showToast(`Membuka WhatsApp untuk menghubungi ${parentName}...`, 'info');
        }

        // Initialize managers
        const securityManager = new SecurityManager();
        const backupManager = new BackupManager();
        const duplicateDetector = new DuplicateDetector();
        const pdfExporter = new PDFExporter();
        const performanceOptimizer = new PerformanceOptimizer();

        // Data storage dengan localStorage (ENCRYPTED) - UPDATED
        let students = [];
        let currentEditIndex = -1;
        let currentPage = 1;
        const rowsPerPage = 20; // Increased for better performance
        let sessionTimer = null;
        let pendingDuplicateCallback = null;

        // Get current academic year
        function getCurrentAcademicYear() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11

            if (currentMonth >= 6) { // July onwards
                return `${currentYear}/${currentYear + 1}`;
            } else {
                return `${currentYear - 1}/${currentYear}`;
            }
        }

        // Format tanggal untuk ditampilkan
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return date.toLocaleDateString('id-ID', options);
        }

        // IMPROVED: Enhanced input validation
        function validateStudentInput(student) {
            const errors = [];

            // Name validation - must be at least 2 words, letters only
            const nameWords = student.nama.trim().split(' ').filter(word => word.length > 0);
            if (nameWords.length < 2) {
                errors.push('Nama harus terdiri dari minimal 2 kata');
            }

            const nameRegex = /^[a-zA-Z\s]+$/;
            if (!nameRegex.test(student.nama)) {
                errors.push('Nama hanya boleh mengandung huruf dan spasi');
            }

            // Age validation - between 10-17 years
            const birthDate = new Date(student.tanggalLahir);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            if (age < 10 || age > 17) {
                errors.push('Usia siswa harus antara 10-17 tahun');
            }

            // Phone validation - Indonesian format
            const phoneRegex = /^(\+62|62|0)[0-9]{9,13}$/;
            if (!phoneRegex.test(student.hpOrtu.replace(/\s+/g, ''))) {
                errors.push('Format nomor HP tidak valid');
            }

            // NISN validation - exactly 10 digits or empty
            if (student.nisn && student.nisn !== '-') {
                const nisnRegex = /^\d{10}$/;
                if (!nisnRegex.test(student.nisn)) {
                    errors.push('NISN harus berisi tepat 10 digit angka');
                }
            }

            return errors;
        }

        // Simpan data ke localStorage (ENCRYPTED) - UPDATED
        function saveStudents() {
            try {
                // Assign unique IDs if missing
                students.forEach((student, index) => {
                    if (!student.id) {
                        student.id = 'STD' + Date.now() + '_' + index;
                    }
                    if (!student.version) {
                        student.version = 1;
                    }
                });

                const encryptedData = securityManager.encryptData(students);
                localStorage.setItem('students_encrypted', encryptedData);

                // Verify data integrity
                backupManager.verifyDataIntegrity(students);
                backupManager.checkStorageUsage();

                // Update data version
                const currentVersion = localStorage.getItem('dataVersion') || '1.0';
                const versionEl = document.getElementById('dataVersion');
                if (versionEl) versionEl.textContent = currentVersion;

                return true;
            } catch (error) {
                console.error('Failed to save students:', error);
                showToast('Gagal menyimpan data!', 'error');
                return false;
            }
        }

        // Load data dari localStorage (ENCRYPTED) - UPDATED
        function loadStudents() {
            try {
                // Try to load encrypted data first
                const encryptedData = localStorage.getItem('students_encrypted');
                if (encryptedData) {
                    const decryptedData = securityManager.decryptData(encryptedData);
                    if (decryptedData && Array.isArray(decryptedData)) {
                        return decryptedData;
                    }
                }

                // Fallback to old unencrypted data (migration)
                const oldData = localStorage.getItem('students');
                if (oldData) {
                    const parsedData = JSON.parse(oldData);
                    if (Array.isArray(parsedData)) {
                        // Migrate to encrypted storage
                        const encryptedData = securityManager.encryptData(parsedData);
                        localStorage.setItem('students_encrypted', encryptedData);
                        localStorage.removeItem('students'); // Remove old data
                        console.log('Data migrated to encrypted storage');
                        return parsedData;
                    }
                }

                return [];
            } catch (error) {
                console.error('Failed to load students:', error);
                showToast('Gagal memuat data!', 'error');
                return [];
            }
        }

        // Session management - NEW
        function startSessionTimer() {
            if (sessionTimer) clearInterval(sessionTimer);

            sessionTimer = setInterval(() => {
                const remaining = securityManager.getSessionTimeRemaining();

                if (remaining <= 0) {
                    logout(true); // Auto logout
                    return;
                }

                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                const sessionTimerEl = document.getElementById('sessionTimer');
                if (sessionTimerEl) {
                    sessionTimerEl.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                // Warning at 5 minutes
                if (remaining <= 5 * 60 * 1000 && remaining > 4 * 60 * 1000) {
                    showToast('Session akan berakhir dalam 5 menit!', 'warning');
                }
            }, 1000);
        }

        // Password visibility toggle - NEW
        function initPasswordToggle() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('passwordToggle');

            if (toggleBtn && passwordInput) {
                toggleBtn.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    const icon = this.querySelector('i');
                    icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
                });
            }
        }

        // Enhanced login error handling - UPDATED
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');

            if (errorDiv && errorMessage) {
                errorMessage.textContent = message;
                errorDiv.classList.add('show');

                // Auto hide after 5 seconds
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 5000);
            }
        }

        // Show login success - NEW
        function showLoginSuccess() {
            const successDiv = document.getElementById('loginSuccess');
            if (successDiv) {
                successDiv.style.display = 'block';
            }
        }

        // Hide login messages - NEW
        function hideLoginMessages() {
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');

            if (errorDiv) errorDiv.classList.remove('show');
            if (successDiv) successDiv.style.display = 'none';
        }

        // Login form handler - UPDATED
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            // Hide previous messages
            hideLoginMessages();

            // Show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading-spinner"></div>Memverifikasi...';

            // Simulate network delay for better UX
            setTimeout(() => {
                const result = securityManager.validateLogin(username, password);

                if (result.success) {
                    showLoginSuccess();
                    securityManager.createSession();

                    setTimeout(() => {
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        startSessionTimer();
                        initializeApp();
                    }, 1500);
                } else {
                    showLoginError(result.message);
                }

                // Restore button state
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-lock"></i> Login';
            }, 1000);
        }

        // Logout function - UPDATED
        function logout(isAutoLogout = false) {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }

            securityManager.clearSession();

            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';

            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            if (isAutoLogout) {
                showToast('Session telah berakhir. Silakan login kembali.', 'warning');
            } else {
                showToast('Logout berhasil!', 'success');
            }
        }

        // Check if already logged in - NEW
        function checkExistingSession() {
            if (securityManager.isSessionValid()) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                startSessionTimer();
                initializeApp();
                return true;
            }
            return false;
        }

        // Initialize the application - UPDATED
        function initializeApp() {
            // Set current year
            const yearEl = document.getElementById('currentYear');
            if (yearEl) yearEl.textContent = getCurrentAcademicYear();

            // Load students data
            students = loadStudents();

            // Initialize displays
            displayStudents();
            updateStatistics();

            // Start auto backup
            backupManager.startAutoBackup();

            // Update backup status
            backupManager.updateBackupStatus();

            console.log('Application initialized with', students.length, 'students');
        }

        // IMPROVED: Enhanced student form handler with duplicate detection
        function handleStudentForm(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading-spinner"></div>Menyimpan...';

            const student = {
                id: currentEditIndex >= 0 ? students[currentEditIndex].id : 'STD' + Date.now(),
                nama: document.getElementById('nama').value.trim(),
                jenisKelamin: document.getElementById('jenisKelamin').value,
                tempatLahir: document.getElementById('tempatLahir').value.trim(),
                tanggalLahir: document.getElementById('tanggalLahir').value,
                alamat: document.getElementById('alamat').value.trim(),
                namaOrtu: document.getElementById('namaOrtu').value.trim(),
                hpOrtu: document.getElementById('hpOrtu').value.trim(),
                asalSekolah: document.getElementById('asalSekolah').value.trim(),
                nisn: document.getElementById('nisn').value.trim() || '-',
                tanggalDaftar: currentEditIndex >= 0 ? students[currentEditIndex].tanggalDaftar : new Date().toISOString().split('T')[0],
                version: 1
            };

            // Enhanced validation
            const validationErrors = validateStudentInput(student);
            if (validationErrors.length > 0) {
                showToast('Error: ' + validationErrors[0], 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            // Check for duplicates (skip if editing the same student)
            const duplicates = duplicateDetector.checkForDuplicates(student.nama, students, currentEditIndex);

            if (duplicates.length > 0 && !pendingDuplicateCallback) {
                // Show duplicate warning
                duplicateDetector.showDuplicateWarning(duplicates, () => {
                    // This callback will be called if user chooses to continue
                    proceedWithSave(student, submitBtn, originalText);
                });

                // Restore button state for now
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            // Proceed with save if no duplicates or user confirmed
            proceedWithSave(student, submitBtn, originalText);
        }

        // NEW: Proceed with saving student data
        function proceedWithSave(student, submitBtn, originalText) {
            // Simulate save delay for better UX
            setTimeout(() => {
                if (currentEditIndex >= 0) {
                    students[currentEditIndex] = student;
                    showToast('Data berhasil diperbarui!', 'success');
                } else {
                    students.push(student);
                    showToast('Pendaftaran berhasil!', 'success');
                }

                if (saveStudents()) {
                    // Create backup after save
                    backupManager.createAutoBackup(students);

                    displayStudents();
                    updateStatistics();
                    resetForm();

                    // Show success message
                    const successMessage = document.getElementById('successMessage');
                    if (successMessage) {
                        successMessage.style.display = 'block';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 3000);
                    }
                }

                // Hide duplicate warning if shown
                duplicateDetector.hideDuplicateWarning();
                pendingDuplicateCallback = null;

                // Restore button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 1000);
        }

        // NEW: Handle duplicate detection buttons
        function viewDuplicate() {
            if (window.duplicateInfo) {
                const student = window.duplicateInfo.student;
                showToast(`Data ditemukan: ${student.nama} dari ${student.asalSekolah}`, 'info');

                // Switch to list page and highlight the duplicate
                showPage('list');

                // Scroll to student (simple implementation)
                setTimeout(() => {
                    const rows = document.querySelectorAll('#studentTableBody tr');
                    rows.forEach(row => {
                        if (row.textContent.includes(student.nama)) {
                            row.style.backgroundColor = '#fff3cd';
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setTimeout(() => {
                                row.style.backgroundColor = '';
                            }, 3000);
                        }
                    });
                }, 500);
            }
            duplicateDetector.hideDuplicateWarning();
        }

        function continueAnyway() {
            if (window.duplicateCallback) {
                pendingDuplicateCallback = true;
                window.duplicateCallback();
            }
            duplicateDetector.hideDuplicateWarning();
        }

        // Reset form - UPDATED
        function resetForm() {
            document.getElementById('studentForm').reset();
            currentEditIndex = -1;

            const submitBtn = document.getElementById('submitBtn');
            const formModeLabel = document.getElementById('formModeLabel');

            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save"></i> Daftar Sekarang';
            if (formModeLabel) {
                formModeLabel.textContent = 'Mode: Tambah Data';
                formModeLabel.style.color = '#4CAF50';
            }

            // Hide success and duplicate messages
            const successMessage = document.getElementById('successMessage');
            if (successMessage) successMessage.style.display = 'none';
            duplicateDetector.hideDuplicateWarning();

            // Add real-time duplicate checking to name input
            const namaInput = document.getElementById('nama');
            if (namaInput) {
                namaInput.addEventListener('input', performanceOptimizer.debouncedSearch((value) => {
                    if (value.length >= 3) {
                        const duplicates = duplicateDetector.checkForDuplicates(value, students, currentEditIndex);
                        if (duplicates.length > 0 && duplicates[0].similarity > 0.9) {
                            const bestMatch = duplicates[0];
                            namaInput.style.borderColor = '#ffc107';
                            namaInput.title = `Nama serupa: ${bestMatch.student.nama}`;
                        } else {
                            namaInput.style.borderColor = '#e9ecef';
                            namaInput.title = '';
                        }
                    }
                }));
            }
        }

        // Edit student - UPDATED
        function editStudent(index) {
            const student = students[index];
            currentEditIndex = index;

            // Fill form
            const fields = {
                nama: student.nama,
                jenisKelamin: student.jenisKelamin,
                tempatLahir: student.tempatLahir,
                tanggalLahir: student.tanggalLahir,
                alamat: student.alamat,
                namaOrtu: student.namaOrtu,
                hpOrtu: student.hpOrtu,
                asalSekolah: student.asalSekolah,
                nisn: student.nisn === '-' ? '' : student.nisn
            };

            Object.keys(fields).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = fields[key];
            });

            // Update UI
            const submitBtn = document.getElementById('submitBtn');
            const formModeLabel = document.getElementById('formModeLabel');

            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-edit"></i> Update Data';
            if (formModeLabel) {
                formModeLabel.textContent = 'Mode: Edit Data - ' + student.nama;
                formModeLabel.style.color = '#ffc107';
            }

            // Switch to form page
            showPage('form');

            // Scroll to top
            window.scrollTo(0, 0);

            showToast('Data dimuat untuk diedit', 'success');
        }

        // Delete student - UPDATED
        function deleteStudent(index) {
            const student = students[index];

            if (confirm(`Yakin ingin menghapus data ${student.nama}?\n\nTindakan ini tidak dapat dibatalkan!`)) {
                students.splice(index, 1);

                if (saveStudents()) {
                    displayStudents();
                    updateStatistics();
                    showToast(`Data ${student.nama} berhasil dihapus!`, 'success');

                    // Create backup after delete
                    backupManager.createAutoBackup(students);
                }
            }
        }

        // IMPROVED: Display students with performance optimization
        function displayStudents() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

            // Use performance optimizer for large datasets
            if (students.length > 100) {
                performanceOptimizer.optimizeTableRendering(students, searchTerm);
            } else {
                standardDisplayStudents(searchTerm);
            }
        }

        // Standard display for smaller datasets
        function standardDisplayStudents(searchTerm) {
            const tbody = document.getElementById('studentTableBody');

            // Filter students based on search
            let filteredStudents = students;
            if (searchTerm) {
                filteredStudents = students.filter(student =>
                    student.nama.toLowerCase().includes(searchTerm) ||
                    student.asalSekolah.toLowerCase().includes(searchTerm) ||
                    student.namaOrtu.toLowerCase().includes(searchTerm)
                );
            }

            // Calculate pagination
            const totalPages = Math.ceil(filteredStudents.length / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const currentStudents = filteredStudents.slice(startIndex, endIndex);

            // Build HTML
            let html = '';
            if (currentStudents.length === 0) {
                html = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
                            ${searchTerm ? 'Tidak ada data yang sesuai dengan pencarian' : 'Belum ada data pendaftar'}
                        </td>
                    </tr>
                `;
            } else {
                currentStudents.forEach((student, index) => {
                    const bgColor = student.jenisKelamin === 'Laki-laki' ? '#e3f2fd' : '#fce4ec';
                    const textColor = student.jenisKelamin === 'Laki-laki' ? '#1976d2' : '#c2185b';

                    html += `
                        <tr>
                            <td>${startIndex + index + 1}</td>
                            <td><strong>${student.nama}</strong></td>
                            <td><span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; background: ${bgColor}; color: ${textColor}">
                                ${student.jenisKelamin}
                            </span></td>
                            <td>${student.tempatLahir}, ${formatDate(student.tanggalLahir)}</td>
                            <td>${student.asalSekolah}</td>
                            <td>${performanceOptimizer.renderPhoneNumber(student.hpOrtu, student.namaOrtu)}</td>
                            <td>
                                <button class="btn btn-warning" onclick="editStudent(${students.indexOf(student)})" style="padding: 8px 12px; margin: 2px; font-size: 12px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteStudent(${students.indexOf(student)})" style="padding: 8px 12px; margin: 2px; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            if (tbody) tbody.innerHTML = html;
            updatePagination(totalPages, filteredStudents.length);
        }

        // Update pagination - NEW
        function updatePagination(totalPages, totalStudents) {
            const paginationDiv = document.querySelector('.pagination');
            if (!paginationDiv) return;

            paginationDiv.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Prev';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayStudents();
                }
            };
            paginationDiv.appendChild(prevBtn);

            // Page info
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages} (${totalStudents} data)`;
            paginationDiv.appendChild(pageInfo);

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayStudents();
                }
            };
            paginationDiv.appendChild(nextBtn);
        }

        // Update statistics - UPDATED
        function updateStatistics() {
            const total = students.length;
            const lakiLakiCount = students.filter(s => s.jenisKelamin === 'Laki-laki').length;
            const perempuanCount = students.filter(s => s.jenisKelamin === 'Perempuan').length;

            const elements = {
                totalPendaftar: total,
                lakiLaki: lakiLakiCount,
                perempuan: perempuanCount
            };

            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = elements[id];
            });

            // Update data integrity percentage
            const integrityPercentage = backupManager.verifyDataIntegrity(students) ? '100%' : '99%';
            const integrityEl = document.getElementById('dataIntegrity');
            if (integrityEl) integrityEl.textContent = integrityPercentage;

            // School statistics
            const schoolStats = {};
            students.forEach(student => {
                schoolStats[student.asalSekolah] = (schoolStats[student.asalSekolah] || 0) + 1;
            });

            const schoolStatsDiv = document.getElementById('schoolStats');
            if (schoolStatsDiv) {
                if (total > 0) {
                    const sortedSchools = Object.entries(schoolStats)
                        .sort(([, a], [, b]) => b - a)
                        .slice(0, 5);

                    schoolStatsDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <strong>Top 5 Asal Sekolah:</strong>
                        </div>
                        ${sortedSchools.map(([school, count], index) => `
                            <div style="margin: 8px 0; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; display: flex; justify-content: space-between;">
                                <span>${index + 1}. ${school}</span>
                                <strong>${count} siswa</strong>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px; padding: 10px; background: rgba(30, 60, 114, 0.1); border-radius: 8px;">
                            <strong>Rasio Gender:</strong><br>
                            Laki-laki: ${total > 0 ? ((lakiLakiCount / total) * 100).toFixed(1) : 0}%<br>
                            Perempuan: ${total > 0 ? ((perempuanCount / total) * 100).toFixed(1) : 0}%
                        </div>
                    `;
                } else {
                    schoolStatsDiv.innerHTML = '<p>Belum ada data pendaftaran</p>';
                }
            }
        }

        // Show page - UPDATED
        function showPage(pageName) {
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            const navBtn = document.querySelector(`[onclick="showPage('${pageName}')"]`);
            const page = document.getElementById(pageName);

            if (navBtn) navBtn.classList.add('active');
            if (page) page.classList.add('active');

            // Reset pagination when switching pages
            currentPage = 1;

            // Refresh data when showing list or stats
            if (pageName === 'list') {
                displayStudents();
            } else if (pageName === 'stats') {
                updateStatistics();
            }
        }

        // Search functionality - IMPROVED
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            const debouncedSearch = performanceOptimizer.debouncedSearch(() => {
                currentPage = 1; // Reset to first page
                displayStudents();
            });

            searchInput.addEventListener('input', function () {
                debouncedSearch(this.value);
            });
        }

        // Export to Excel - UPDATED
        // Export to Excel - ENHANCED WITH HEADER AND STYLING
        function exportToExcel() {
            if (students.length === 0) {
                showToast('Tidak ada data untuk diekspor!', 'warning');
                return;
            }

            try {
                // Get current academic year dynamically
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0-11
                let academicYear;

                if (currentMonth >= 6) { // July onwards (month 6 = July)
                    academicYear = `${currentYear}/${currentYear + 1}`;
                } else {
                    academicYear = `${currentYear - 1}/${currentYear}`;
                }

                // Prepare data for the table (starting from row 5 because of headers)
                const exportData = students.map((student, index) => ({
                    'No': index + 1,
                    'Nama Lengkap': student.nama,
                    'Jenis Kelamin': student.jenisKelamin,
                    'Tempat Lahir': student.tempatLahir,
                    'Tanggal Lahir': formatDate(student.tanggalLahir),
                    'Alamat': student.alamat,
                    'Nama Orang Tua/Wali': student.namaOrtu,
                    'No. HP Orang Tua': student.hpOrtu,
                    'Asal Sekolah': student.asalSekolah,
                    'NISN': student.nisn,
                    'Tanggal Daftar': formatDate(student.tanggalDaftar)
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData, { origin: 'A5' }); // Start data from row 5

                // Add headers manually
                XLSX.utils.sheet_add_aoa(ws, [
                    ['LAPORAN PENERIMAAN SISWA BARU'], // Row 1
                    [`SMP MUSLIMIN CILILIN - TAHUN AJARAN ${academicYear}`], // Row 2
                    [''], // Row 3 - empty
                    [''] // Row 4 - empty
                ], { origin: 'A1' });

                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data Pendaftar");

                // ===== STYLING SECTION =====

                // Auto-resize columns
                const max_width = exportData.reduce((w, r) => Math.max(w, r['Nama Lengkap'].length), 10);
                ws["!cols"] = [
                    { width: 5 },  // No
                    { width: Math.min(max_width, 35) }, // Nama
                    { width: 15 }, // Jenis Kelamin
                    { width: 20 }, // Tempat Lahir
                    { width: 25 }, // Tanggal Lahir
                    { width: Math.min(max_width, 45) }, // Alamat (diperbesar)
                    { width: 25 }, // Nama Ortu
                    { width: 20 }, // HP
                    { width: 25 }, // Asal Sekolah
                    { width: 12 }, // NISN
                    { width: 15 }  // Tanggal Daftar
                ];

                // Merge cells for headers
                ws["!merges"] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 10 } }, // Merge A1:K1 for title
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 10 } }  // Merge A2:K2 for subtitle
                ];

                // Apply styles to cells
                const range = XLSX.utils.decode_range(ws['!ref']);

                // Style for title (Row 1)
                if (ws['A1']) {
                    ws['A1'].s = {
                        font: { bold: true, sz: 16, name: "Arial" },
                        alignment: { horizontal: "center", vertical: "center" },
                        fill: { fgColor: { rgb: "FFFFFF" } }
                    };
                }

                // Style for subtitle (Row 2)
                if (ws['A2']) {
                    ws['A2'].s = {
                        font: { bold: true, sz: 14, name: "Arial" },
                        alignment: { horizontal: "center", vertical: "center" },
                        fill: { fgColor: { rgb: "FFFFFF" } }
                    };
                }

                // Style for table headers (Row 5) - Pastel Green Background
                const headerRow = 4; // Row 5 (0-indexed)
                for (let col = 0; col <= 10; col++) { // Columns A to K
                    const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: col });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { bold: true, sz: 11, name: "Arial", color: { rgb: "000000" } },
                            fill: { fgColor: { rgb: "90EE90" } }, // Light green pastel
                            alignment: { horizontal: "center", vertical: "center", wrapText: true },
                            border: {
                                top: { style: "thin", color: { rgb: "000000" } },
                                bottom: { style: "thin", color: { rgb: "000000" } },
                                left: { style: "thin", color: { rgb: "000000" } },
                                right: { style: "thin", color: { rgb: "000000" } }
                            }
                        };
                    }
                }

                // Style for data rows - Add borders
                for (let row = headerRow + 1; row <= range.e.r; row++) {
                    for (let col = 0; col <= 10; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (ws[cellAddress]) {
                            ws[cellAddress].s = {
                                font: { sz: 10, name: "Arial" },
                                alignment: {
                                    horizontal: col === 0 ? "center" : "left", // Center for No column
                                    vertical: "center",
                                    wrapText: true
                                },
                                border: {
                                    top: { style: "thin", color: { rgb: "000000" } },
                                    bottom: { style: "thin", color: { rgb: "000000" } },
                                    left: { style: "thin", color: { rgb: "000000" } },
                                    right: { style: "thin", color: { rgb: "000000" } }
                                }
                            };

                            // Alternate row colors (zebra striping)
                            if (row % 2 === 0) {
                                ws[cellAddress].s.fill = { fgColor: { rgb: "F8F9FA" } }; // Very light gray
                            }
                        }
                    }
                }

                // Set row heights
                ws["!rows"] = [
                    { hpt: 15 }, // Row 1 - Title
                    { hpt: 15 }, // Row 2 - Subtitle
                    { hpt: 12 }, // Row 3 - Empty
                    { hpt: 12 }, // Row 4 - Empty
                    { hpt: 17 }  // Row 5 - Headers (taller for better readability)
                ];

                // Add additional row heights for data rows
                for (let i = 5; i < students.length + 5; i++) {
                    if (!ws["!rows"][i]) ws["!rows"][i] = {};
                    ws["!rows"][i].hpt = 20; // Data row height
                }

                // Generate filename with timestamp
                const fileName = `Laporan_Pendaftar_SMP_Muslimin_${academicYear.replace('/', '-')}_${new Date().toISOString().split('T')[0]}.xlsx`;

                // Save file
                XLSX.writeFile(wb, fileName);

                showToast(`Laporan Excel berhasil diekspor ke ${fileName}!`, 'success');

                // Log for debugging
                console.log(`Excel exported: ${students.length} students, Academic Year: ${academicYear}`);

            } catch (error) {
                console.error('Export failed:', error);
                showToast('Gagal mengekspor data ke Excel!', 'error');
            }
        }

        // Fungsi bantu untuk format nomor HP
        function formatPhoneNumber(phone) {
            return phone.toString().replace(/(\d{4})(\d{4})(\d{4})/, '$1-$2-$3');
        }

        // Emergency backup function - UPDATED
        function createEmergencyBackup() {
            if (students.length === 0) {
                showToast('Tidak ada data untuk dibackup!', 'warning');
                return;
            }

            backupManager.createEmergencyBackup(students);
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Check for existing session first
            if (checkExistingSession()) {
                return;
            }

            // Initialize components
            initPasswordToggle();
            initializeSearch();

            // Set initial page visibility
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';

            // Bind event listeners
            const loginForm = document.getElementById('loginForm');
            const studentForm = document.getElementById('studentForm');

            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (studentForm) studentForm.addEventListener('submit', handleStudentForm);

            console.log('ðŸ”¥ System initialized - Login page ready!');
        });
    </script>
</body>

</html>